<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RELMED</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-browser-check.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-survey-multi-choice.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-survey-likert.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="utils.js"></script>
    <script>
        window.maxWarnings = 15; // How many warnings before kick out
        window.interimWarning = 5; // How many missing responses before a please change your ways message
        window.max_warnings_per_task = 3; // How many times to show no response warning in a task - only for RELMED context
        window.relemd_default_response_deadline = 4000;
        window.prolific_default_response_deadline = 3000;
        window.default_long_response_deadline = 6000;

        // Print all url parameters to console
        const urlParams = () => {
            const params = new URLSearchParams(window.location.search);
            for (const [key, value] of params.entries()) {
                console.log(`${key}: ${value}`);
            }
        }

        // Initialize jsPysch object
        let jsPsych = initJsPsych({
            display_element: 'display_element',
            on_trial_finish: (data) => {

                // If there are events
                if (window.pause_resume_events.length !== 0){

                    // Add to data
                    data.pause_resume_events = window.pause_resume_events

                    // Clear buffer
                    window.pause_resume_events = [];
                }
            },
            on_close: saveDataREDCap
        });
        
        // Get condition from URL, all caps are prolific, lowercase are ours
        window.context = typeof jsPsych.data.getURLVariable('RELMED_PID') === "undefined" ? "prolific" : "relmed"
        window.participantID = window.context === "relmed" ? jsPsych.data.getURLVariable('RELMED_PID') : jsPsych.data.getURLVariable('PROLIFIC_PID') ;
        window.debug = window.participantID.includes("debug") || window.participantID.includes("TST");
        window.demo = window.participantID.includes("DEMO") | window.participantID.includes("STAF");
        window.azurePID = jsPsych.data.getURLVariable('azure_PID');
        window.session = jsPsych.data.getURLVariable('session');
        window.task = jsPsych.data.getURLVariable('task');
        window.last_state = jsPsych.data.getURLVariable('state') || "none";

        // Context specific response deadline
        window.default_response_deadline = window.context === "relmed" ? window.relemd_default_response_deadline : window.prolific_default_response_deadline;
        
        // Save participant variables to data
        jsPsych.data.addProperties({
            participant_id: window.participantID,
            session: window.session,
            n_warnings: 0,
            version: "0.3",
            task: window.task,
            pre_kick_out_warned: false
        })

        // Buffer for experiment start / pause events
        window.pause_resume_events = [];

    </script>
    <script src="resumption.js"></script>
    <script src="ctrl-plugins/plugin-ctrl-explore-trial-2.js"></script>
    <script src="ctrl-plugins/plugin-ctrl-predict-trial-mouse.js"></script>
    <script src="ctrl-plugins/plugin-ctrl-reward-trial.js"></script>
    <script src="ctrl-plugins/plugin-ctrl-reward-prompt.js"></script>
    <script src="open-text//plugin-survey-text_jo.js"></script>
    <script src="plugin-PILT.js"></script>
    <script src="plugin-survey-template.js"></script>
    <script src="pilot6_reversal_sequence.js"></script>
    <script src="plugin-reversal.js"></script>
    <script src="reversal.js"></script>
    <script src="plugin-coin-lottery.js"></script>
    <script src="press_test.js"></script>
    <script src="PILT.js"></script>
    <script src="PILT_instructions.js"></script>
    <script src="vigour.js"></script>
    <script src="vigour_instructions.js"></script>
    <script src="post-vigour-test.js"></script>
    <script src="PIT.js"></script>
    <script src="acceptability.js"></script>
    <script src="questionnaires.js"></script>
    <script src="discounting.js"></script>
    <script src="control_instructions_interactive.js"></script>
    <script src="control_self_report.js"></script>
    <script src="control_sequences.js"></script>
    <script src="build_control_timeline.js"></script>
    <script src="open-text/study_config.js"></script>
    <script src="open-text/tasks/questions.js"></script>
    <script src="open-text/tasks/instructions.js"></script>
    <script src="open-text/experiment.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="vigour_styles.css" rel="stylesheet" type="text/css" />
    <link href="PIT_styles.css" rel="stylesheet" type="text/css" />
    <link href="reversal.css" rel="stylesheet" type="text/css" />
    <link href="PILT.css" rel="stylesheet" type="text/css" />
    <link href="control_instruction_styles.css" rel="stylesheet" type="text/css" />
    <link href="control_styles.css" rel="stylesheet" type="text/css" />
    <link href="open-text/openText_style.css" rel="stylesheet" type="text/css" />
    <link href="dd.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
    }

    .instructions p {
        width: 700px;
        text-align: left;
    }

    .instructions td {
        padding-left: 20px;
        padding-right: 20px
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
</body>
<script>
    // Preliminary checks
    const save_start_time = {
        type: jsPsychCallFunction,
        func: function() {
            window.module_start_time = format_date_from_string(jsPsych.getStartTime());
            jsPsych.data.addProperties({
                module_start_time: module_start_time
            });
        }
    }

    const enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        css_classes: ['instructions'],
        message: "<p>This study runs in full screen mode.</p><p>Press the button below to continue.</p>"
    };
    
    let welcome_txt;
    if (window.context === "prolific"){
        welcome_txt = `<p><b>Thank you for taking part in this study!</b></p>
                <p>The purpose of this study is to examine how people learn from positive and negative feedback while playing games.
                <p>In this study, you'll play a few simple trial-and-error learning games. Your goal in each game is to win as many coins as possible.</p>
                <p>The games may feel a bit fast-paced because we're interested in your quick, intuitive decisions. Since they're designed around learning from experience, making mistakes is completely expected. Over time, you'll figure out better choices and improve your performance.</p>
                `;
    } else {
        welcome_txt = `<p><b>Thank you for taking part in this RELMED session!</b></p>
                <p>The purpose of this session is to examine how people learn from positive and negative feedback while playing games.
                <p>You will play a few simple trial-and-error learning games. Your goal in each game is to win as many coins as possible.</p>
                <p>The games may feel a bit fast-paced because we're interested in your quick, intuitive decisions. Since they're designed around learning from experience, making mistakes is completely expected. Over time, you'll figure out better choices and improve your performance.</p>
                `;
    }

    const resumption_msg = {
        type: jsPsychInstructions,
        css_classes: ['instructions'],
        pages: [
            `<p>Welcome back to this module!</p>
            <p>It seems that your participation has been interrupted. Don't worry, you can continue from where you left off.</p>
            <p>Please try to complete the module in one go, without interruption.</p>`
        ],
        show_clickable_nav: true,
        data: {trialphase: "resumption_instructions"}
    }

    const welcome_msgs = {
        type: jsPsychInstructions,
        css_classes: ['instructions'],
        pages: [
            welcome_txt
        ],
        show_clickable_nav: true,
        data: {trialphase: "instruction"}
    }
    
    // End of experiment message
    let end_exp_msg_content = [];
    if (window.context === "relmed") {
        end_exp_msg_content = [
            `<p>Thank you for completing this module!</p>
            <p>When you click continue, your data will be uploaded to the secure server. This may take up to two minutes. Please don't close or refresh your browser at this time.</p>
            <p>When data upload is complete, you will be redirected back to My RELMED.</p>`];
    } else {
        end_exp_msg_content = [
            `<p>Thank you for participating in this study!</p>
            <p>The purpose of this study is to develop games that can measure people's individual learning tendencies. In the future, these games will be used to facilitate mental health research ongoing at UCL.</p>`,
            `<p>When you click continue, your data will be uploaded to the server. This may take up to two minutes.Please don't close or refresh your browser at this time.</p>
            <p>When data upload is complete, you will be rediredted to Prolific to complete your submission</p>`];
    }
    const end_experiment_msgs = [
        {
            type: jsPsychInstructions,
            css_classes: ['instructions'],
            pages: end_exp_msg_content,
            show_clickable_nav: true,
            data: {trialphase: "experiment_end_message"}
        },
        {                
            type: jsPsychHtmlKeyboardResponse,
            css_classes: ['instructions'],
            stimulus: "<p>Uploading data. Please don't close or refresh this window.</p>",
            data: {trialphase: "end"},
            data: {trialphase: "data_upload"},
            on_start: end_experiment
        }
    ]

    function run_full_experiment(PILT_structure, test_structure, WM_procedure, WM_test_procedure, LTM_procedure, LTM_test_procedure){

        let procedure = [];

        // Save start time
        procedure = procedure.concat(save_start_time);

        // Fullscreen prompt
        if (window.context === "prolific"){
            procedure.push(enter_fullscreen);
        }

        // Resumption message
        if (window.last_state !== "none" && window.context === "relmed") {
            procedure.push(resumption_msg);
        }

        // Create card choosing timelines
        if (["pilt-to-test", "pilt", "pilt_test", "wm", "ltm", "wm_only", "screening"].includes(window.task)){
            PILT_tasks = return_PILT_full_sequence(PILT_structure, test_structure, WM_procedure, WM_test_procedure, LTM_procedure, LTM_test_procedure);
        }

        if (window.task === "pilt-to-test") {

            // Preload
            procedure.push(preload_PILT);

            // Welcome message
            procedure.push({
                type: jsPsychInstructions,
                css_classes: ['instructions'],
                pages:  [
                `<p>Welcome back!</p>
                <p>You will now play more games of trial and error learning.</p>
                <p>Like before, these are fast paced and everyone is expected to make more than a few mistakes.</p>`,
                ],
                show_clickable_nav: true,
                data: {trialphase: "instruction"}
            });

            // Add max pres rate only if vigour / PIT included
            if (resumptionRule(pilt_to_test_order, window.last_state, "pit_task_start")) {
                // Add max press rate test
                console.log("Adding max press rate");
                procedure = procedure.concat(maxPressTimeline);
            }
            
            if (resumptionRule(pilt_to_test_order, window.last_state, "pilt_last_block_start")) {
                // Add PILT task timeline
                console.log("Adding PILT");
                procedure = procedure.concat(PILT_tasks.PILT_procedure);
                procedure = procedure.concat([
                    acceptability_intro,
                    acceptability_PILT
                ]);
            }

            if (resumptionRule(pilt_to_test_order, window.last_state, "vigour_task_start")) {
                // Add vigour task timeline
                console.log("Adding vigour");
                const vigourTimeline = [
                    preload_vigour,
                    vigourInstructions,
                    ...experimentTimeline,
                ];
                procedure = procedure.concat(vigourTimeline);
                procedure = procedure.concat([
                    acceptability_intro,
                    acceptability_vigour
                ]);
            }

            if (resumptionRule(pilt_to_test_order, window.last_state, "pit_task_start")) {
                // Add PIT timeline: instructions, trials, bonus
                console.log("Adding PIT");
                const PITtimeline = [
                    PITinstructions,
                    PITtrials
                ];
                procedure = procedure.concat(PITtimeline);
                procedure = procedure.concat([
                    acceptability_intro,
                    acceptability_PIT
                ]);
            }

            if (resumptionRule(pilt_to_test_order, window.last_state, "vigour_pit_bonus_start")) {
                // Add vigour bonus message
                console.log("Adding vigour bonus");
                procedure.push(vigour_PIT_bonus2);
            }

            if (resumptionRule(pilt_to_test_order, window.last_state, "vigour_test_task_start")) {
                // Add post-vigour test
                console.log("Adding post-vigour test");
                procedure = procedure.concat(postVigourInstructions);
                procedure = procedure.concat(postVigourTrials);
            }

            // PILT & Pavlovian test 
            console.log("Adding PILT test");
            procedure = procedure.concat(PILT_tasks.PILT_test_procedure);

            // Add coin lottery
            procedure.push(lottery_instructions);
            procedure.push(coin_lottery);
        }

        if (window.task == "pilt") {
            // Preload
            procedure.push(preload_PILT);

            procedure.push({
                type: jsPsychInstructions,
                css_classes: ['instructions'],
                pages:  [
                `<p>Welcome back!</p>
                <p>You will now play more games of trial and error learning.</p>
                <p>Like before, these are fast paced and everyone is expected to make more than a few mistakes.</p>`,
                ],
                show_clickable_nav: true,
                data: {trialphase: "instruction"}
            });

            procedure = procedure.concat(PILT_tasks.PILT_procedure);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_PILT
            ]);
        }

        if (window.task == "pilt_test") {
            // Preload
            procedure.push(preload_PILT);

            procedure = procedure.concat(PILT_tasks.PILT_test_procedure);
        }

        if (window.task == "vigour") {
            // Preload
            procedure.push(preload_vigour);
            
            // Add max press rate test
            procedure = procedure.concat(maxPressTimeline);

            // Add vigour task timeline
            const vigourTimeline = [
                vigourInstructions,
                ...experimentTimeline,
            ];
            procedure = procedure.concat(vigourTimeline);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_vigour
            ]);
        }

        if (window.task == "pit") {
            // Add PIT timeline: instructions, trials, bonus
            const PITtimeline = [
                preload_vigour,
                PITinstructions,
                PITtrials
            ];
            procedure = procedure.concat(PITtimeline);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_PIT
            ]);
        }

        if (window.task == "ltm") {
            // Preload
            procedure.push(preload_wm_ltm);

            // Add LTM block
            procedure.push(PILT_tasks.LTM_procedure);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_ltm
            ]);

            // Add post-LTM test
            procedure.push(PILT_tasks.LTM_test_procedure);
        }
        
        // This is a module used by relemd.ac.uk. For WM only, see wm_only
        if (window.task === "wm") {
            // Preload
            procedure.push(preload_wm_ltm);

            if (resumptionRule(wm_order, window.last_state, "ltm_task_start")) {
                // Add LTM block
                console.log("Adding LTM");
                procedure.push(PILT_tasks.LTM_procedure);
                procedure = procedure.concat([
                    acceptability_intro,
                    acceptability_ltm
                ]);
            }

            if (resumptionRule(wm_order, window.last_state, "ltm_test_task_start")) {
                // Add post-LTM test
                console.log("Adding post-LTM test");
                procedure.push(PILT_tasks.LTM_test_procedure);
            }
            
            if (resumptionRule(wm_order, window.last_state, "wm_task_start")) {
                // Add WM block
                console.log("Adding WM");
                procedure.push(PILT_tasks.WM_procedure);
                procedure = procedure.concat([
                    acceptability_intro,
                    acceptability_wm
                ]);
            }

            if (resumptionRule(wm_order, window.last_state, "wm_test_task_start")) {
                // Add post-WM test
                console.log("Adding post-WM test");
                procedure.push(PILT_tasks.WM_test_procedure);
            }

            if (["wk24", "wk28"].includes(window.session)) {
                
                if (resumptionRule(wm_order, window.last_state, "dd_task_start")) {
                    // Add delay discounting timeline
                    console.log("Adding delay discounting");
                    procedure = procedure.concat(dd_timeline);
                }
                
                if (resumptionRule(wm_order, window.last_state, "open_text_task_start")) {
                    // Free text
                    console.log("Adding open text");
                    procedure.push(openTextTimeline);
                }
            }
        }

        if (window.task === "wm_only") {
            // Preload
            procedure.push(preload_wm_ltm);

            // Add WM block
            procedure.push(PILT_tasks.WM_procedure);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_wm
            ]);

            // Add post-WM test
            procedure.push(PILT_tasks.WM_test_procedure);
        }


        if (window.task === "reversal") {

            // Preload
            procedure.push(reversal_preload);
            
            // Welcome message
            if (window.last_state === "none"){
                procedure.push(welcome_msgs);
            }

            // Add reversal timeline
            procedure = procedure.concat(reversal_instructions);
            procedure = procedure.concat(reversal_blocks);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_reversal
            ]);
        }

        if (window.task === "open_text"){
            procedure.push(openTextTimeline);
        }
        
        if (window.task == "control") {
            // Control
            procedure.push(controlTimeline);
        }

        if (window.task === "dd") {
            // Add delay discounting timeline
            procedure = procedure.concat(dd_timeline);
        }

        if (window.task === "quests"){

            // Report loading successful
            procedure.push({
                type: jsPsychCallFunction,
                func: function() {
                    // Report to tests
                    console.log("load_successful")

                    // Report to relmed.ac.uk
                    postToParent({message: "load_successful"})
                }
            });

            if (["wk0", "wk2", "wk4"].includes(window.session)) {

                if (resumptionRule(quests_order, window.last_state, "dd_task_start")) {
                    // Add delay discounting timeline
                    procedure = procedure.concat(dd_timeline);
                }
                
                if (resumptionRule(quests_order, window.last_state, "open_text_task_start")) {
                    // Free text
                    procedure.push(openTextTimeline);
                }
            }

            // Add questionnaire timeline
            procedure = procedure.concat(questionnaires_timeline);
        }

        if (window.task === "screening") {
            // Preload
            procedure.push(reversal_preload);

            // Welcome message
            procedure.push(welcome_msgs);

            // Add reversal timeline
            procedure = procedure.concat(reversal_instructions);
            procedure = procedure.concat(reversal_blocks);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_reversal
            ]);

            // Preload
            procedure.push(preload_PILT);

            procedure.push({
                type: jsPsychInstructions,
                css_classes: ['instructions'],
                pages:  [
                `<p>You will now play another game of trial and error learning.</p>
                <p>Like before, these are fast paced and everyone is expected to make more than a few mistakes.</p>`,
                ],
                show_clickable_nav: true,
                data: {trialphase: "instruction"}
            });

            procedure = procedure.concat(PILT_tasks.PILT_procedure);
            procedure = procedure.concat([
                acceptability_intro,
                acceptability_PILT
            ]);

            // Add questionnaire timeline
            procedure = procedure.concat(questionnaires_timeline);
        }


        // Final messages and data saving
        procedure = procedure.concat(end_experiment_msgs);

        // Prevent right clicking and refreshing the page
        if (!debug) {
            // Prevent right-click
            document.addEventListener('contextmenu', event => event.preventDefault());

            document.addEventListener("keydown", (e) => {
                if (e.key === "F12" || (e.ctrlKey && e.shiftKey && e.key === "I") || (e.metaKey && e.code === "KeyI")) {
                    e.preventDefault();
                }
            });

            // Prompt before refresh
            window.addEventListener('beforeunload', preventRefresh);

        }

        // Add event listener for pause  / resume messages from relmed.ac.uk
        if (window.context === "relmed"){
            
            window.addEventListener("message", (event) => {
                // Check origin for security
                if (!(["localhost:3000", "https://relmed.ac.uk"].includes(event.origin))) return;

                const msg = event.data.message;
                console.log("Message received from parent:", msg);

                if (msg === "pause_task"){
                    console.log("Experiment paused")
                    window.pause_resume_events.push({time: jsPsych.getTotalTime(), event: "pause"})
                    jsPsych.pauseExperiment()
                }

                if (msg === "resume_task"){
                    console.log("Experiment resumed")
                    window.pause_resume_events.push({time: jsPsych.getTotalTime(), event: "resume"})
                    jsPsych.resumeExperiment()
                }
            }, false);

        }

        // Run
        if (window.participantID.includes("simulate")) {
            const simulation_options = {
                default: {
                    speed_up: true,
                    speed_up_factor: 10,
                    data: {
                    rt: 200
                    }
                }
            }

            if (window.participantID.includes("SLOW")) {
                simulation_options.default.speed_up = false;
                simulation_options.default.speed_up_factor = 1;
            }

            jsPsych.simulate(procedure, "visual", simulation_options);
        } else {
            jsPsych.run(procedure);
        }
    }

    // Load sequences and start
    var procedure = [];

    load_sequences(window.session);
</script>
</html>